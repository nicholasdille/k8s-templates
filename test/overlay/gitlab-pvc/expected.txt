apiVersion: v1
kind: ConfigMap
metadata:
  name: db-config
  namespace: gitlab
data:
  postgresql.conf: "# -----------------------------\n# PostgreSQL configuration file\n#
    -----------------------------\n#\n# This file consists of lines of the form:\n#\n#
    \  name = value\n#\n# (The \"=\" is optional.)  Whitespace may be used.  Comments
    are introduced with\n# \"#\" anywhere on a line.  The complete list of parameter
    names and allowed\n# values can be found in the PostgreSQL documentation.\n#\n#
    The commented-out settings shown in this file represent the default values.\n#
    Re-commenting a setting is NOT sufficient to revert it to the default value;\n#
    you need to reload the server.\n#\n# This file is read on server startup and when
    the server receives a SIGHUP\n# signal.  If you edit the file on a running system,
    you have to SIGHUP the\n# server for the changes to take effect, or use \"pg_ctl
    reload\".  Some\n# parameters, which are marked below, require a server shutdown
    and restart to\n# take effect.\n#\n# Any parameter can also be given as a command-line
    option to the server, e.g.,\n# \"postgres -c log_connections=on\".  Some parameters
    can be changed at run time\n# with the \"SET\" SQL command.\n#\n# Memory units:
    \ kB = kilobytes        Time units:  ms  = milliseconds\n#                MB =
    megabytes                     s   = seconds\n#                GB = gigabytes                     min
    = minutes\n#                TB = terabytes                     h   = hours\n#
    \                                                  d   = days\n\n\n#------------------------------------------------------------------------------\n#
    FILE LOCATIONS\n#------------------------------------------------------------------------------\n\n#
    The default values of these variables are driven from the -D command-line\n# option
    or PGDATA environment variable, represented here as ConfigDir.\n\n#data_directory
    = 'ConfigDir'\t\t# use data in another directory\n          # (change requires
    restart)\n#hba_file = 'ConfigDir/pg_hba.conf'\t# host-based authentication file\n
    \         # (change requires restart)\n#ident_file = 'ConfigDir/pg_ident.conf'\t#
    ident configuration file\n          # (change requires restart)\n\n# If external_pid_file
    is not explicitly set, no extra PID file is written.\n#external_pid_file = ''\t\t\t#
    write an extra PID file\n          # (change requires restart)\n\n\n#------------------------------------------------------------------------------\n#
    CONNECTIONS AND AUTHENTICATION\n#------------------------------------------------------------------------------\n\n#
    - Connection Settings -\n\nlisten_addresses = '*'\n          # comma-separated
    list of addresses;\n          # defaults to 'localhost'; use '*' for all\n          #
    (change requires restart)\n#port = 5432\t\t\t\t# (change requires restart)\nmax_connections
    = 200\t\t\t# (change requires restart)\n#superuser_reserved_connections = 3\t#
    (change requires restart)\n#unix_socket_directories = '/var/run/postgresql'\t#
    comma-separated list of directories\n          # (change requires restart)\n#unix_socket_group
    = ''\t\t\t# (change requires restart)\n#unix_socket_permissions = 0777\t\t# begin
    with 0 to use octal notation\n          # (change requires restart)\n#bonjour
    = off\t\t\t\t# advertise server via Bonjour\n          # (change requires restart)\n#bonjour_name
    = ''\t\t\t# defaults to the computer name\n          # (change requires restart)\n\n#
    - Security and Authentication -\n\n#authentication_timeout = 1min\t\t# 1s-600s\n#ssl
    = off\t\t\t\t# (change requires restart)\n#ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
    # allowed SSL ciphers\n          # (change requires restart)\n#ssl_prefer_server_ciphers
    = on\t\t# (change requires restart)\n#ssl_ecdh_curve = 'prime256v1'\t\t# (change
    requires restart)\n#ssl_cert_file = 'server.crt'\t\t# (change requires restart)\n#ssl_key_file
    = 'server.key'\t\t# (change requires restart)\n#ssl_ca_file = ''\t\t\t# (change
    requires restart)\n#ssl_crl_file = ''\t\t\t# (change requires restart)\n#password_encryption
    = on\n#db_user_namespace = off\n#row_security = on\n\n# GSSAPI using Kerberos\n#krb_server_keyfile
    = ''\n#krb_caseins_users = off\n\n# - TCP Keepalives -\n# see \"man 7 tcp\" for
    details\n\n#tcp_keepalives_idle = 0\t\t# TCP_KEEPIDLE, in seconds;\n          #
    0 selects the system default\n#tcp_keepalives_interval = 0\t\t# TCP_KEEPINTVL,
    in seconds;\n          # 0 selects the system default\n#tcp_keepalives_count =
    0\t\t# TCP_KEEPCNT;\n          # 0 selects the system default\n\n\n#------------------------------------------------------------------------------\n#
    RESOURCE USAGE (except WAL)\n#------------------------------------------------------------------------------\n\n#
    - Memory -\n\nshared_buffers = 128MB\t\t\t# min 128kB\n          # (change requires
    restart)\n#huge_pages = try\t\t\t# on, off, or try\n          # (change requires
    restart)\n#temp_buffers = 8MB\t\t\t# min 800kB\n#max_prepared_transactions = 0\t\t#
    zero disables the feature\n          # (change requires restart)\n# Caution: it
    is not advisable to set max_prepared_transactions nonzero unless\n# you actively
    intend to use prepared transactions.\n#work_mem = 4MB\t\t\t\t# min 64kB\n#maintenance_work_mem
    = 64MB\t\t# min 1MB\n#replacement_sort_tuples = 150000\t# limits use of replacement
    selection sort\n#autovacuum_work_mem = -1\t\t# min 1MB, or -1 to use maintenance_work_mem\n#max_stack_depth
    = 2MB\t\t\t# min 100kB\ndynamic_shared_memory_type = posix\t# the default is the
    first option\n          # supported by the operating system:\n          #   posix\n
    \         #   sysv\n          #   windows\n          #   mmap\n          # use
    none to disable dynamic shared memory\n          # (change requires restart)\n\n#
    - Disk -\n\n#temp_file_limit = -1\t\t\t# limits per-process temp file space\n
    \         # in kB, or -1 for no limit\n\n# - Kernel Resource Usage -\n\n#max_files_per_process
    = 1000\t\t# min 25\n          # (change requires restart)\nshared_preload_libraries
    = 'pg_stat_statements'\t\t# (change requires restart)\n\n# - Cost-Based Vacuum
    Delay -\n\n#vacuum_cost_delay = 0\t\t\t# 0-100 milliseconds\n#vacuum_cost_page_hit
    = 1\t\t# 0-10000 credits\n#vacuum_cost_page_miss = 10\t\t# 0-10000 credits\n#vacuum_cost_page_dirty
    = 20\t\t# 0-10000 credits\n#vacuum_cost_limit = 200\t\t# 1-10000 credits\n\n#
    - Background Writer -\n\n#bgwriter_delay = 200ms\t\t\t# 10-10000ms between rounds\n#bgwriter_lru_maxpages
    = 100\t\t# 0-1000 max buffers written/round\n#bgwriter_lru_multiplier = 2.0\t\t#
    0-10.0 multiplier on buffers scanned/round\n#bgwriter_flush_after = 512kB\t\t#
    measured in pages, 0 disables\n\n# - Asynchronous Behavior -\n\n#effective_io_concurrency
    = 1\t\t# 1-1000; 0 disables prefetching\n#max_worker_processes = 8\t\t# (change
    requires restart)\n#max_parallel_workers_per_gather = 0\t# taken from max_worker_processes\n#old_snapshot_threshold
    = -1\t\t# 1min-60d; -1 disables; 0 is immediate\n          # (change requires
    restart)\n#backend_flush_after = 0\t\t# measured in pages, 0 disables\n\n\n#------------------------------------------------------------------------------\n#
    WRITE AHEAD LOG\n#------------------------------------------------------------------------------\n\n#
    - Settings -\n\n#wal_level = minimal\t\t\t# minimal, replica, or logical\n          #
    (change requires restart)\n#fsync = on\t\t\t\t# flush data to disk for crash safety\n
    \           # (turning this off can cause\n            # unrecoverable data corruption)\n#synchronous_commit
    = on\t\t# synchronization level;\n          # off, local, remote_write, remote_apply,
    or on\n#wal_sync_method = fsync\t\t# the default is the first option\n          #
    supported by the operating system:\n          #   open_datasync\n          #   fdatasync
    (default on Linux)\n          #   fsync\n          #   fsync_writethrough\n          #
    \  open_sync\n#full_page_writes = on\t\t\t# recover from partial page writes\n#wal_compression
    = off\t\t\t# enable compression of full-page writes\n#wal_log_hints = off\t\t\t#
    also do full page writes of non-critical updates\n          # (change requires
    restart)\n#wal_buffers = -1\t\t\t# min 32kB, -1 sets based on shared_buffers\n
    \         # (change requires restart)\n#wal_writer_delay = 200ms\t\t# 1-10000
    milliseconds\n#wal_writer_flush_after = 1MB\t\t# measured in pages, 0 disables\n\n#commit_delay
    = 0\t\t\t# range 0-100000, in microseconds\n#commit_siblings = 5\t\t\t# range
    1-1000\n\n# - Checkpoints -\n\n#checkpoint_timeout = 5min\t\t# range 30s-1d\n#max_wal_size
    = 1GB\n#min_wal_size = 80MB\n#checkpoint_completion_target = 0.5\t# checkpoint
    target duration, 0.0 - 1.0\n#checkpoint_flush_after = 256kB\t\t# measured in pages,
    0 disables\n#checkpoint_warning = 30s\t\t# 0 disables\n\n# - Archiving -\n\n#archive_mode
    = off\t\t# enables archiving; off, on, or always\n        # (change requires restart)\n#archive_command
    = ''\t\t# command to use to archive a logfile segment\n        # placeholders:
    %p = path of file to archive\n        #               %f = file name only\n        #
    e.g. 'test ! -f /mnt/server/archivedir/%f && cp %p /mnt/server/archivedir/%f'\n#archive_timeout
    = 0\t\t# force a logfile segment switch after this\n        # number of seconds;
    0 disables\n\n\n#------------------------------------------------------------------------------\n#
    REPLICATION\n#------------------------------------------------------------------------------\n\n#
    - Sending Server(s) -\n\n# Set these on the master and on any standby that will
    send replication data.\n\n#max_wal_senders = 0\t\t# max number of walsender processes\n
    \       # (change requires restart)\n#wal_keep_segments = 0\t\t# in logfile segments,
    16MB each; 0 disables\n#wal_sender_timeout = 60s\t# in milliseconds; 0 disables\n\n#max_replication_slots
    = 0\t# max number of replication slots\n        # (change requires restart)\n#track_commit_timestamp
    = off\t# collect timestamp of transaction commit\n        # (change requires restart)\n\n#
    - Master Server -\n\n# These settings are ignored on a standby server.\n\n#synchronous_standby_names
    = ''\t# standby servers that provide sync rep\n        # number of sync standbys
    and comma-separated list of application_name\n        # from standby(s); '*' =
    all\n#vacuum_defer_cleanup_age = 0\t# number of xacts by which cleanup is delayed\n\n#
    - Standby Servers -\n\n# These settings are ignored on a master server.\n\n#hot_standby
    = off\t\t\t# \"on\" allows queries during recovery\n          # (change requires
    restart)\n#max_standby_archive_delay = 30s\t# max delay before canceling queries\n
    \         # when reading WAL from archive;\n          # -1 allows indefinite delay\n#max_standby_streaming_delay
    = 30s\t# max delay before canceling queries\n          # when reading streaming
    WAL;\n          # -1 allows indefinite delay\n#wal_receiver_status_interval =
    10s\t# send replies at least this often\n          # 0 disables\n#hot_standby_feedback
    = off\t\t# send info from standby to prevent\n          # query conflicts\n#wal_receiver_timeout
    = 60s\t\t# time that receiver waits for\n          # communication from master\n
    \         # in milliseconds; 0 disables\n#wal_retrieve_retry_interval = 5s\t#
    time to wait before retrying to\n          # retrieve WAL after a failed attempt\n\n\n#------------------------------------------------------------------------------\n#
    QUERY TUNING\n#------------------------------------------------------------------------------\n\n#
    - Planner Method Configuration -\n\n#enable_bitmapscan = on\n#enable_hashagg =
    on\n#enable_hashjoin = on\n#enable_indexscan = on\n#enable_indexonlyscan = on\n#enable_material
    = on\n#enable_mergejoin = on\n#enable_nestloop = on\n#enable_seqscan = on\n#enable_sort
    = on\n#enable_tidscan = on\n\n# - Planner Cost Constants -\n\n#seq_page_cost =
    1.0\t\t\t# measured on an arbitrary scale\n#random_page_cost = 4.0\t\t\t# same
    scale as above\n#cpu_tuple_cost = 0.01\t\t\t# same scale as above\n#cpu_index_tuple_cost
    = 0.005\t\t# same scale as above\n#cpu_operator_cost = 0.0025\t\t# same scale
    as above\n#parallel_tuple_cost = 0.1\t\t# same scale as above\n#parallel_setup_cost
    = 1000.0\t# same scale as above\n#min_parallel_relation_size = 8MB\n#effective_cache_size
    = 4GB\n\n# - Genetic Query Optimizer -\n\n#geqo = on\n#geqo_threshold = 12\n#geqo_effort
    = 5\t\t\t# range 1-10\n#geqo_pool_size = 0\t\t\t# selects default based on effort\n#geqo_generations
    = 0\t\t\t# selects default based on effort\n#geqo_selection_bias = 2.0\t\t# range
    1.5-2.0\n#geqo_seed = 0.0\t\t\t# range 0.0-1.0\n\n# - Other Planner Options -\n\n#default_statistics_target
    = 100\t# range 1-10000\n#constraint_exclusion = partition\t# on, off, or partition\n#cursor_tuple_fraction
    = 0.1\t\t# range 0.0-1.0\n#from_collapse_limit = 8\n#join_collapse_limit = 8\t\t#
    1 disables collapsing of explicit\n          # JOIN clauses\n#force_parallel_mode
    = off\n\n\n#------------------------------------------------------------------------------\n#
    ERROR REPORTING AND LOGGING\n#------------------------------------------------------------------------------\n\n#
    - Where to Log -\n\nlog_destination = 'stderr'\t\t# Valid values are combinations
    of\n          # stderr, csvlog, syslog, and eventlog,\n          # depending on
    platform.  csvlog\n          # requires logging_collector to be on.\n\n# This
    is used when logging to stderr:\nlogging_collector = on\t\t# Enable capturing
    of stderr and csvlog\n          # into log files. Required to be on for\n          #
    csvlogs.\n          # (change requires restart)\n\n# These are only used if logging_collector
    is on:\nlog_directory = 'pg_log'\t\t# directory where log files are written,\n
    \         # can be absolute or relative to PGDATA\nlog_filename = 'postgresql.log'\t#
    log file name pattern,\n          # can include strftime() escapes\nlog_file_mode
    = 0600\t\t\t# creation mode for log files,\n          # begin with 0 to use octal
    notation\nlog_truncate_on_rotation = on\t\t# If on, an existing log file with
    the\n          # same name as the new log file will be\n          # truncated
    rather than appended to.\n          # But such truncation only occurs on\n          #
    time-driven rotation, not on restarts\n          # or size-driven rotation.  Default
    is\n          # off, meaning append to existing files\n          # in all cases.\nlog_rotation_age
    = 1d\t\t\t# Automatic rotation of logfiles will\n          # happen after that
    time.  0 disables.\nlog_rotation_size = 0\t\t# Automatic rotation of logfiles
    will\n          # happen after that much log output.\n          # 0 disables.\n\n#
    These are relevant when logging to syslog:\n#syslog_facility = 'LOCAL0'\n#syslog_ident
    = 'postgres'\n#syslog_sequence_numbers = on\n#syslog_split_messages = on\n\n#
    This is only relevant when logging to eventlog (win32):\n# (change requires restart)\n#event_source
    = 'PostgreSQL'\n\n# - When to Log -\n\nclient_min_messages = warning\t\t# values
    in order of decreasing detail:\n          #   debug5\n          #   debug4\n          #
    \  debug3\n          #   debug2\n          #   debug1\n          #   log\n          #
    \  notice\n          #   warning\n          #   error\n\nlog_min_messages = warning\t\t#
    values in order of decreasing detail:\n          #   debug5\n          #   debug4\n
    \         #   debug3\n          #   debug2\n          #   debug1\n          #
    \  info\n          #   notice\n          #   warning\n          #   error\n          #
    \  log\n          #   fatal\n          #   panic\n\nlog_min_error_statement =
    warning\t# values in order of decreasing detail:\n          #   debug5\n          #
    \  debug4\n          #   debug3\n          #   debug2\n          #   debug1\n
    \         #   info\n          #   notice\n          #   warning\n          #   error\n
    \         #   log\n          #   fatal\n          #   panic (effectively off)\n\nlog_min_duration_statement
    = -1\t# -1 is disabled, 0 logs all statements\n          # and their durations,
    > 0 logs only\n          # statements running at least this number\n          #
    of milliseconds\n\n\n# - What to Log -\n\n#debug_print_parse = off\n#debug_print_rewritten
    = off\n#debug_print_plan = off\n#debug_pretty_print = on\n#log_checkpoints = off\nlog_connections
    = on\nlog_disconnections = on\nlog_duration = on\nlog_error_verbosity = default\t\t#
    terse, default, or verbose messages\n#log_hostname = off\nlog_line_prefix = '%t%e'\t\t\t#
    special values:\n          #   %a = application name\n          #   %u = user
    name\n          #   %d = database name\n          #   %r = remote host and port\n
    \         #   %h = remote host\n          #   %p = process ID\n          #   %t
    = timestamp without milliseconds\n          #   %m = timestamp with milliseconds\n
    \         #   %n = timestamp with milliseconds (as a Unix epoch)\n          #
    \  %i = command tag\n          #   %e = SQL state\n          #   %c = session
    ID\n          #   %l = session line number\n          #   %s = session start timestamp\n
    \         #   %v = virtual transaction ID\n          #   %x = transaction ID (0
    if none)\n          #   %q = stop here in non-session\n          #        processes\n
    \         #   %% = '%'\n          # e.g. '<%u%%%d> '\n#log_lock_waits = off\t\t\t#
    log lock waits >= deadlock_timeout\n#log_statement = 'none'\t\t\t# none, ddl,
    mod, all\n#log_replication_commands = off\n#log_temp_files = -1\t\t\t# log temporary
    files equal or larger\n          # than the specified size in kilobytes;\n          #
    -1 disables, 0 logs all temp files\nlog_timezone = 'UTC'\n\n\n# - Process Title
    -\n\n#cluster_name = ''\t\t\t# added to process titles if nonempty\n          #
    (change requires restart)\n#update_process_title = on\n\n\n#------------------------------------------------------------------------------\n#
    RUNTIME STATISTICS\n#------------------------------------------------------------------------------\n\n#
    - Query/Index Statistics Collector -\n\n#track_activities = on\n#track_counts
    = on\n#track_io_timing = off\n#track_functions = none\t\t\t# none, pl, all\n#track_activity_query_size
    = 1024\t# (change requires restart)\n#stats_temp_directory = 'pg_stat_tmp'\n\n\n#
    - Statistics Monitoring -\n\n#log_parser_stats = off\n#log_planner_stats = off\n#log_executor_stats
    = off\n#log_statement_stats = off\n\n\n#------------------------------------------------------------------------------\n#
    AUTOVACUUM PARAMETERS\n#------------------------------------------------------------------------------\n\n#autovacuum
    = on\t\t\t# Enable autovacuum subprocess?  'on'\n          # requires track_counts
    to also be on.\n#log_autovacuum_min_duration = -1\t# -1 disables, 0 logs all actions
    and\n          # their durations, > 0 logs only\n          # actions running at
    least this number\n          # of milliseconds.\n#autovacuum_max_workers = 3\t\t#
    max number of autovacuum subprocesses\n          # (change requires restart)\n#autovacuum_naptime
    = 1min\t\t# time between autovacuum runs\n#autovacuum_vacuum_threshold = 50\t#
    min number of row updates before\n          # vacuum\n#autovacuum_analyze_threshold
    = 50\t# min number of row updates before\n          # analyze\n#autovacuum_vacuum_scale_factor
    = 0.2\t# fraction of table size before vacuum\n#autovacuum_analyze_scale_factor
    = 0.1\t# fraction of table size before analyze\n#autovacuum_freeze_max_age = 200000000\t#
    maximum XID age before forced vacuum\n          # (change requires restart)\n#autovacuum_multixact_freeze_max_age
    = 400000000\t# maximum multixact age\n          # before forced vacuum\n          #
    (change requires restart)\n#autovacuum_vacuum_cost_delay = 20ms\t# default vacuum
    cost delay for\n          # autovacuum, in milliseconds;\n          # -1 means
    use vacuum_cost_delay\n#autovacuum_vacuum_cost_limit = -1\t# default vacuum cost
    limit for\n          # autovacuum, -1 means use\n          # vacuum_cost_limit\n\n\n#------------------------------------------------------------------------------\n#
    CLIENT CONNECTION DEFAULTS\n#------------------------------------------------------------------------------\n\n#
    - Statement Behavior -\n\n#search_path = '\"$user\", public'\t# schema names\n#default_tablespace
    = ''\t\t# a tablespace name, '' uses the default\n#temp_tablespaces = ''\t\t\t#
    a list of tablespace names, '' uses\n          # only default tablespace\n#check_function_bodies
    = on\n#default_transaction_isolation = 'read committed'\n#default_transaction_read_only
    = off\n#default_transaction_deferrable = off\n#session_replication_role = 'origin'\n#statement_timeout
    = 0\t\t\t# in milliseconds, 0 is disabled\n#lock_timeout = 0\t\t\t# in milliseconds,
    0 is disabled\n#idle_in_transaction_session_timeout = 0\t\t# in milliseconds,
    0 is disabled\n#vacuum_freeze_min_age = 50000000\n#vacuum_freeze_table_age = 150000000\n#vacuum_multixact_freeze_min_age
    = 5000000\n#vacuum_multixact_freeze_table_age = 150000000\n#bytea_output = 'hex'\t\t\t#
    hex, escape\n#xmlbinary = 'base64'\n#xmloption = 'content'\n#gin_fuzzy_search_limit
    = 0\n#gin_pending_list_limit = 4MB\n\n# - Locale and Formatting -\n\ndatestyle
    = 'iso, mdy'\n#intervalstyle = 'postgres'\ntimezone = 'UTC'\n#timezone_abbreviations
    = 'Default'     # Select the set of available time zone\n          # abbreviations.
    \ Currently, there are\n          #   Default\n          #   Australia (historical
    usage)\n          #   India\n          # You can create your own file in\n          #
    share/timezonesets/.\n#extra_float_digits = 0\t\t\t# min -15, max 3\n#client_encoding
    = sql_ascii\t\t# actually, defaults to database\n          # encoding\n\n# These
    settings are initialized by initdb, but they can be changed.\nlc_messages = 'en_US.utf8'\t\t\t#
    locale for system error message\n          # strings\nlc_monetary = 'en_US.utf8'\t\t\t#
    locale for monetary formatting\nlc_numeric = 'en_US.utf8'\t\t\t# locale for number
    formatting\nlc_time = 'en_US.utf8'\t\t\t\t# locale for time formatting\n\n# default
    configuration for text search\ndefault_text_search_config = 'pg_catalog.english'\n\n#
    - Other Defaults -\n\n#dynamic_library_path = '$libdir'\n#local_preload_libraries
    = ''\n#session_preload_libraries = ''\n\n\n#------------------------------------------------------------------------------\n#
    LOCK MANAGEMENT\n#------------------------------------------------------------------------------\n\n#deadlock_timeout
    = 1s\n#max_locks_per_transaction = 64\t\t# min 10\n          # (change requires
    restart)\n#max_pred_locks_per_transaction = 64\t# min 10\n          # (change
    requires restart)\n\n\n#------------------------------------------------------------------------------\n#
    VERSION/PLATFORM COMPATIBILITY\n#------------------------------------------------------------------------------\n\n#
    - Previous PostgreSQL Versions -\n\n#array_nulls = on\n#backslash_quote = safe_encoding\t#
    on, off, or safe_encoding\n#default_with_oids = off\n#escape_string_warning =
    on\n#lo_compat_privileges = off\n#operator_precedence_warning = off\n#quote_all_identifiers
    = off\n#sql_inheritance = on\n#standard_conforming_strings = on\n#synchronize_seqscans
    = on\n\n# - Other Platforms and Clients -\n\n#transform_null_equals = off\n\n\n#------------------------------------------------------------------------------\n#
    ERROR HANDLING\n#------------------------------------------------------------------------------\n\n#exit_on_error
    = off\t\t\t# terminate session on any error?\n#restart_after_crash = on\t\t# reinitialize
    after backend crash?\n\n\n#------------------------------------------------------------------------------\n#
    CONFIG FILE INCLUDES\n#------------------------------------------------------------------------------\n\n#
    These options allow settings to be loaded from files other than the\n# default
    postgresql.conf.\n\n#include_dir = 'conf.d'\t\t\t# include files ending in '.conf'
    from\n          # directory 'conf.d'\n#include_if_exists = 'exists.conf'\t# include
    file only if it exists\n#include = 'special.conf'\t\t# include file\n\n\n#------------------------------------------------------------------------------\n#
    CUSTOMIZED OPTIONS\n#------------------------------------------------------------------------------\n\n#
    Add settings for extensions here\n"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-extensions
  namespace: gitlab
data:
  install_extensions.sql: |
    CREATE EXTENSION IF NOT EXISTS pg_trgm;
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: db
  namespace: gitlab
spec:
  replicas: 1
  selector:
    matchLabels:
      pod: db
  template:
    metadata:
      labels:
        pod: db
    spec:
      volumes:
      - name: config
        configMap:
          name: db
      - name: init
        configMap:
          name: db-extensions
      - name: db
        persistentVolumeClaim:
          claimName: gitlab
      - name: tz-config
        hostPath:
          path: /usr/share/zoneinfo/Europe/Berlin
      containers:
      - name: main
        image: postgres:9.6
        env:
        - name: POSTGRES_DB
          value: gitlab
        - name: POSTGRES_USER
          value: gitlab
        - name: POSTGRES_PASSWORD
          value: uLhEv7zzkvQGy879F5FUhQ==
        volumeMounts:
        - mountPath: /etc/postgresql/postgresql.conf
          name: config
        - mountPath: /docker-entrypoint-initdb.d
          name: init
        - mountPath: /var/lib/postgresql/data
          name: db
          subPath: db-data
        - mountPath: /etc/localtime
          name: tz-config
        ports:
        - name: db
          containerPort: 5432
---
apiVersion: v1
kind: Service
metadata:
  name: db
  namespace: gitlab
spec:
  selector:
    pod: db
  ports:
  - protocol: TCP
    port: 5432
    targetPort: 5432
---
apiVersion: externaldns.k8s.io/v1alpha1
kind: DNSEndpoint
metadata:
  name: gitlab
spec:
  endpoints:
  - dnsName: gitlab.freecastle.eu
    recordTTL: 180
    recordType: CNAME
    targets:
    - lb.master.k8s.freecastle.eu
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gitaly
  namespace: gitlab
data:
  GITLAB_OMNIBUS_CONFIG: |
    # Avoid running unnecessary services on the gitaly server
    postgresql['enable'] = false
    redis['enable'] = false
    nginx['enable'] = false
    unicorn['enable'] = false
    sidekiq['enable'] = false
    gitlab_workhorse['enable'] = false

    # Prevent database connections during 'gitlab-ctl reconfigure'
    gitlab_rails['rake_cache_clear'] = false
    gitlab_rails['auto_migrate'] = false

    # Configure the gitlab-shell API callback URL. Without this, `git push` will
    # fail. This can be your 'front door' GitLab URL or an internal load
    # balancer.
    gitlab_rails['internal_api_url'] = 'http://server'

    # Fix for authentication against API
    gitlab_workhorse['auth_backend'] = 'http://server'

    # Make Gitaly accept connections on all network interfaces. You must use
    # firewalls to restrict access to this address/port.
    gitaly['listen_addr'] = '0.0.0.0:8075'
    gitaly['auth_token'] = 'RB1OK5Cnbj1+dzHakasbMw=='

    gitaly['storage'] = [
      { 'name' => 'default', 'path' => '/var/opt/gitlab-data/git-data/repositories' },
    ]

    # prometheus
    prometheus['enable'] = false
    gitlab_monitor['listen_address'] = '0.0.0.0'
    gitlab_monitor['listen_port'] = '9168'
    gitaly['prometheus_listen_addr'] = "0.0.0.0:9236"
    node_exporter['listen_address'] = '0.0.0.0:9100'
    redis_exporter['listen_address'] = '0.0.0.0:9121'
    postgres_exporter['listen_address'] = '0.0.0.0:9187'
    gitlab_rails['monitoring_whitelist'] = ['127.0.0.0/8','10.42.0.0/16']
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitaly
  namespace: gitlab
spec:
  replicas: 1
  selector:
    matchLabels:
      pod: gitaly
  template:
    metadata:
      labels:
        pod: gitaly
    spec:
      containers:
      - name: main
        image: gitlab/gitlab-ce:12.7.5-ce.0
        env:
        - name: GITLAB_OMNIBUS_CONFIG
          valueFrom:
            configMapKeyRef:
              name: gitaly
              key: GITLAB_OMNIBUS_CONFIG
        ports:
        - name: gitaly
          containerPort: 8075
        volumeMounts:
        - mountPath: /var/opt/gitlab
          name: gitaly
          subPath: gitaly-data
        - mountPath: /etc/gitlab
          name: gitaly
          subPath: gitaly-config
        - mountPath: /var/log/gitlab
          name: gitaly
          subPath: gitaly-log
        - mountPath: /etc/localtime
          name: tz-config
      volumes:
      - name: gitaly
        persistentVolumeClaim:
          claimName: gitlab
      - name: tz-config
        hostPath:
          path: /usr/share/zoneinfo/Europe/Berlin
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: gitlab
  namespace: gitlab
spec:
  entryPoints:
  - http
  routes:
  - match: Host(`gitlab.freecastle.eu`)
    kind: Rule
    priority: 12
    services:
    - name: server
      port: 80
      strategy: RoundRobin
---
apiVersion: v1
kind: Namespace
metadata:
  name: gitlab
  metadata:
    labels:
      name: gitlab
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis
  namespace: gitlab
data:
  GITLAB_OMNIBUS_CONFIG: |
    external_url 'https://gitlab.dille.io'

    # Disable all services except Redis
    redis_master_role['enable'] = true

    # Redis configuration
    redis['port'] = 6379
    redis['bind'] = '0.0.0.0'

    # If you wish to use Redis authentication (recommended)
    redis['password'] = 'WLZxbUpLVTQFngqiCdt/sg=='
    gitlab_rails['redis_password'] = 'WLZxbUpLVTQFngqiCdt/sg=='

    # Disable automatic database migrations
    #   Only the primary GitLab application server should handle migrations
    gitlab_rails['auto_migrate'] = false

    # prometheus
    prometheus['enable'] = false
    gitlab_monitor['listen_address'] = '0.0.0.0'
    gitlab_monitor['listen_port'] = '9168'
    gitaly['prometheus_listen_addr'] = "0.0.0.0:9236"
    node_exporter['listen_address'] = '0.0.0.0:9100'
    redis_exporter['listen_address'] = '0.0.0.0:9121'
    postgres_exporter['listen_address'] = '0.0.0.0:9187'
    gitlab_rails['monitoring_whitelist'] = ['127.0.0.0/8','10.42.0.0/16']
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: gitlab
spec:
  replicas: 1
  selector:
    matchLabels:
      pod: redis
  template:
    metadata:
      labels:
        pod: redis
    spec:
      containers:
      - name: main
        image: gitlab/gitlab-ce:12.7.5-ce.0
        env:
        - name: GITLAB_OMNIBUS_CONFIG
          valueFrom:
            configMapKeyRef:
              name: redis
              key: GITLAB_OMNIBUS_CONFIG
        ports:
        - name: redis
          containerPort: 6379
        volumeMounts:
        - mountPath: /var/opt/gitlab
          name: redis
          subPath: redis-data
        - mountPath: /etc/gitlab
          name: redis
          subPath: redis-config
        - mountPath: /var/log/gitlab
          name: redis
          subPath: redis-log
        - mountPath: /etc/localtime
          name: tz-config
      volumes:
      - name: redis
        persistentVolumeClaim:
          claimName: gitlab
      - name: tz-config
        hostPath:
          path: /usr/share/zoneinfo/Europe/Berlin
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: gitlab
spec:
  selector:
    pod: redis
  ports:
  - protocol: TCP
    port: 6379
    targetPort: 6379
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: server
  namespace: gitlab
data:
  GITLAB_OMNIBUS_CONFIG: |
    # GitLab Pages
    pages_external_url 'http://gitlab.dille.io'
    # Required due to https://gitlab.com/gitlab-org/gitlab-pages/issues/129
    gitlab_pages['inplace_chroot'] = true
    # Set listen-proxy when behind reverse proxy. see https://docs.gitlab.com/ee/administration/pages/#configure-listener-for-reverse-proxy-requests
    gitlab_pages['listen_proxy'] = "0.0.0.0:8090"

    # Initial password for user root
    gitlab_rails['initial_root_password'] = "AAA"

    # Public name and SSL offloading
    external_url 'https://gitlab.dille.io'
    nginx['listen_port'] = 80
    nginx['listen_https'] = false

    # External gitaly
    gitaly['enable'] = false
    git_data_dirs({
      'default' => { 'path' => '/var/opt/gitlab-data/git-data/repositories', 'gitaly_address' => 'tcp://gitaly:8075' },
    })
    gitlab_rails['gitaly_token'] = "RB1OK5Cnbj1+dzHakasbMw=="

    # Misc
    gitlab_rails['lfs_enabled'] = true

    # External postgres
    postgresql['enable'] = false
    gitlab_rails['db_adapter'] = 'postgresql'
    gitlab_rails['db_encoding'] = 'utf8'
    gitlab_rails['db_host'] = 'db'
    gitlab_rails['db_port'] = '5432'
    gitlab_rails['db_database'] = 'gitlab'
    gitlab_rails['db_username'] = 'gitlab'
    gitlab_rails['db_password'] = 'uLhEv7zzkvQGy879F5FUhQ=='

    # External redis
    redis['enable'] = false
    gitlab_rails['redis_host'] = 'redis'
    gitlab_rails['redis_port'] = 6379
    gitlab_rails['redis_password'] = 'WLZxbUpLVTQFngqiCdt/sg=='

    # prometheus
    prometheus['enable'] = false
    gitlab_monitor['listen_address'] = '0.0.0.0'
    gitlab_monitor['listen_port'] = '9168'
    gitaly['prometheus_listen_addr'] = "0.0.0.0:9236"
    node_exporter['listen_address'] = '0.0.0.0:9100'
    redis_exporter['listen_address'] = '0.0.0.0:9121'
    postgres_exporter['listen_address'] = '0.0.0.0:9187'
    gitlab_rails['monitoring_whitelist'] = ['127.0.0.0/8','10.42.0.0/16']
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: server
  namespace: gitlab
spec:
  replicas: 1
  selector:
    matchLabels:
      pod: server
  template:
    metadata:
      labels:
        pod: server
    spec:
      containers:
      - name: main
        image: gitlab/gitlab-ce:12.7.5-ce.0
        env:
        - name: GITLAB_OMNIBUS_CONFIG
          valueFrom:
            configMapKeyRef:
              name: server
              key: GITLAB_OMNIBUS_CONFIG
        ports:
        - name: server
          containerPort: 80
        volumeMounts:
        - mountPath: /var/opt/gitlab
          name: server
          subPath: server-data
        - mountPath: /etc/localtime
          name: tz-config
      volumes:
      - name: server
        persistentVolumeClaim:
          claimName: gitlab
      - name: tz-config
        hostPath:
          path: /usr/share/zoneinfo/Europe/Berlin
---
apiVersion: v1
kind: Service
metadata:
  name: server
  namespace: gitlab
spec:
  selector:
    pod: server
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab
  namespace: gitlab
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: hcloud-volumes
